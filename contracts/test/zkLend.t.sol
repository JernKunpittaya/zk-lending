// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.0;

import {Test, console} from "forge-std/Test.sol";
import "forge-std/console.sol";
// import {Groth16Verifier} from "src/Verifier.sol";
import {zkLend, IHasher} from "src/zkLend.sol";
import {MockToken} from "src/MockToken.sol";
import {HonkVerifier} from "src/Verifier.sol";

contract zkLendTest is Test {
    HonkVerifier public verifier;
    uint256 public constant FIELD_SIZE =
        21888242871839275222246405745257275088548364400416034343698204186575808495617;
    zkLend public zk_lend_mixer;
    MockToken public mUSDC;
    MockToken public mETH;
    IHasher public hasher;

    // Test vars
    address public recipient = 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266;

    function deployPoseidon(bytes memory bytecode) public returns (address) {
        address deployedAddress;
        assembly {
            deployedAddress := create(0, add(bytecode, 0x20), mload(bytecode))
            if iszero(deployedAddress) {
                revert(0, 0)
            }
        }
        return deployedAddress;
    }

    struct MyNote {
        uint256 lend_amt; // in smallest unit (scaled, e.g., x10^4)
        uint256 borrow_amt; // in smallest unit (scaled, e.g., x10^4)
        uint256 will_liq_price; // in smallest unit as integer
        uint256 timestamp;
        bytes32 nullifier;
        bytes32 secret;
    }

    function setUp() public {
        // Deploy Poseidon hasher contract.
        string[] memory inputs = new string[](3);
        inputs[0] = "node";
        inputs[1] = "forge-ffi-scripts/deployPoseidon.js";

        bytes memory poseidonBytecode = vm.ffi(inputs);

        address poseidonHasher;
        assembly {
            poseidonHasher := create(
                0,
                add(poseidonBytecode, 0x20),
                mload(poseidonBytecode)
            )
            if iszero(poseidonHasher) {
                revert(0, 0)
            }
        }

        // Deploy Groth16 verifier contract.
        // verifier = IVerifier(address(new Groth16Verifier()));

        /**
         * Deploy mixer as zk-lending when they only lend
         *
         * - verifier: Groth16 verifierwghat
         * - hasher: Poseidon hasher
         * - merkleTreeHeight: 20
         */

        mUSDC = new MockToken("Mock USDC", "mUSDC", 6, 1_000_000 * 1e6);
        mETH = new MockToken("Mock ETH", "mETH", 6, 1_000_000 * 1e6);
        verifier = new HonkVerifier();
        hasher = IHasher(poseidonHasher);

        zk_lend_mixer = new zkLend(verifier, hasher, 12, mETH, mUSDC);
        // TODO: Shouldnt need this mint directly once we support two side market
        mUSDC.mint(address(zk_lend_mixer), 100_000 * 1e6);
        mETH.mint(address(zk_lend_mixer), 100_000 * 1e18);
    }

    // TODO: Make sure we have all required param to match BIG main circuit
    function _getWitnessAndProof(
        MyNote memory prev_note,
        MyNote memory new_note,
        uint256 _additional_borrow_amt,
        uint256[] memory liquidated_array,
        bytes32[] memory leaves
    ) internal returns (uint256, bytes32, bytes32) {
        // TODO: Make priWitness correct type & value
        string[] memory inputs = new string[](28 + leaves.length);
        inputs[0] = "node";
        inputs[1] = "forge-ffi-scripts/generateWitness.js";
        inputs[2] = vm.toString(prev_note.lend_amt);
        inputs[3] = vm.toString(prev_note.borrow_amt);
        inputs[4] = vm.toString(prev_note.will_liq_price);
        inputs[5] = vm.toString(prev_note.timestamp);
        inputs[6] = vm.toString(prev_note.nullifier);
        inputs[7] = vm.toString(prev_note.secret);

        for (uint256 i = 0; i < liquidated_array.length; i++) {
            inputs[8 + i] = vm.toString(liquidated_array[i]);
        }

        for (uint256 i = 0; i < leaves.length; i++) {
            inputs[8 + liquidated_array.length + i] = vm.toString(leaves[i]);
        }

        bytes memory result = vm.ffi(inputs);
        (uint256 priWitness, bytes32 root, bytes32 nullifierHash) = abi.decode(
            result,
            (uint256, bytes32, bytes32)
        );

        return (priWitness, root, nullifierHash);
    }

    function _getCommitment(
        uint256 lend_amt,
        uint256 borrow_amt,
        uint256 will_liq_price,
        uint256 timestamp
    ) internal returns (bytes32 commitment, bytes32 nullifier, bytes32 secret) {
        string[] memory inputs = new string[](6);
        inputs[0] = "node";
        inputs[1] = "forge-ffi-scripts/generateCommitment.js";
        inputs[2] = vm.toString(lend_amt);
        inputs[3] = vm.toString(borrow_amt);
        inputs[4] = vm.toString(will_liq_price);
        inputs[5] = vm.toString(timestamp);

        bytes memory result = vm.ffi(inputs);
        (commitment, nullifier, secret) = abi.decode(
            result,
            (bytes32, bytes32, bytes32)
        );

        return (commitment, nullifier, secret);
    }

    bytes proof =
        hex"000001d80000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000001d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000003cad046763762e1989daeef1681d7b874e000000000000000000000000000000000018bcb698728b5c9ba23ba742541c810000000000000000000000000000006ed1e77157a3b926a1cbfea71f1547f82700000000000000000000000000000000001715dcc9e4deb60b895b626b959ef00000000000000000000000000000007ccc6fe11238ba4ed5b4003ac763af25c600000000000000000000000000000000000bcbb8c1cd4933fddd84277e453b0f00000000000000000000000000000000f946e988814867705d37ec2f51162b7300000000000000000000000000000000002c0945d569a6a575fe2221a66fac0a000000000000000000000000000000a0324c866edd42b3a59fa846012e36ca3b0000000000000000000000000000000000118ddcbc6d1ed0660b2d59428153d90000000000000000000000000000004eba3c06a40bd2320bf3665cd5a0e72c57000000000000000000000000000000000008ec98c8941cf8adb7145512021fdc0000000000000000000000000000003983bb7c11b0786fc3e0398e654ca46d5400000000000000000000000000000000001c3fd850e229e88a9deebde8d8800d000000000000000000000000000000b4f1ae95b0769faceee931c5308a6682f800000000000000000000000000000000001cf61e8c3a99179ec1a8f5a701ab020000000000000000000000000000003983bb7c11b0786fc3e0398e654ca46d5400000000000000000000000000000000001c3fd850e229e88a9deebde8d8800d000000000000000000000000000000b4f1ae95b0769faceee931c5308a6682f800000000000000000000000000000000001cf61e8c3a99179ec1a8f5a701ab0200000000000000000000000000000095ebbfadc68b825e281094ef32b4eb3e2900000000000000000000000000000000002d177df41364b61b585d0349a85c13000000000000000000000000000000dd985802853308aea5608f860841e2357e00000000000000000000000000000000001b5e8a9414b3ac1628567b93e6f45a000000000000000000000000000000604fcf0d31ff8fefadfcd91fb6d9741cad00000000000000000000000000000000001dd463743855c553d89a9e3012b2f9000000000000000000000000000000c9c81e3340fbb6a580c87e5bf652bce52f00000000000000000000000000000000002a5159be57c9707516e78f8f8d34b500000000000000000000000000000081192cc5325681787a5241fd1264d1d23b00000000000000000000000000000000000fdbf2392a379c79b2e6e3967cd0e80000000000000000000000000000002f9d88f18175a6e46090450011ee848cb200000000000000000000000000000000001c912140866cb8249f093a16b083cf2fb783e52d3632f7f1c05e76606568a9dcd108220f816bad9b9dc031ac1ace4300acca8db3fb6d31c68fe740211befb34b62e0266a3804e3a844356243e531be2e474a46cfab69a5c35b330e46070161455ec62950911207c3d060aecdce3fa324c6bb257448d7933382fc92ae40f3ca7be15202dc5b100df59bfa75ca149c7e1a639dd8149e9ec354c95a1a26af258a445cf7862108fe5252669c521e1b029f02d1476dd3656bfb1579bade541d0989bb731a58aee61200b7b51253dec816eb1a67abab6423debbc0bfe5064751f15869eb5ca51b822825001798f7dc50fc7e02affebf88af55b7142998eda30c1041e88aa420f3bfed4f7237ae9eef6ea70e20a6fe9b3b8407aaf4eb3c27ccceeea358a79d682ee6ea4818f6d094ca943d29113324edd7fe3a0a6461049de0d6f4f346acbc69e0748069aef8d5afe4172a5a254ab03d41bed99dccfbc5af4bc03755923e3a33838cdb2276a45dbacbf1a0ab2e540c0c7d95540d326bd7a01284b327fbc621b19108544dcb59da00bd6150161c46cb7e6362255df08580537bcfae515e65b469ded04bd8410b18972bbe9a790d335e0f53831fa96362f8ee7ebce947968f8829e410573a1916a5ea3b382ad810c6ad34015e08e1f9fb49ca8c3f4d383299ecb417044ba8d55b4cd75b39a5af00923fc3156ccefa23ce8825b631c70e3db169fd57d604227147a07de27d7256189d366cb27d19d396150d918487cf926ff21cba6e3e7bac10ba3d9841b187ae05b313117c36f85e8ad35ecb76d4f61101caea4e275f22a26b743af9cf07b99224ac178b18be4b1f56e7eb460249ca3ba1f9ac236c0d726dc7597b875d74e7b708b557cfd89250b20bc0b443cb8a68d0e5f7eebf147583400d3c699cf49933900730293ca7d5160e360145e52b07897cc253b0771911302718c919138c2d110e051ad90369dd4b268b5d805a46650ca2ca223efef58548a6f86f78c196c161920a3f200b50ad8663615b73254b614ac47a91e32f504e9fbc1eb28e3cdb18e4b1250e586dc0cbd4d990e8c02838aba8c887f78f5ab8d440e51263435a6c1afebd24d0265e5f219de7606bf1515759c5dff4dd0d201153acd23ed98ac73506ec1930029350d240e0635a7054a7502c1af5c03662bf51ba374da6dfeb35f2af4ae8144c02736a8ff9b9e8b4cf80114c0bcd2863b2904ef55fc198760db437b27db023e1c61c1312050f17a0befe807e9666b6d7182666207af859c6b18ac8180be018d5ffb6ebf9259bd879864a5b2515105d10770dec1de8ea1d41b2d6c08ea9e429c009547bf2b81c47cc716aaaffe35e437729b9be1b76fafd3298a7ecc77c390638262f93418523457f69462617da07a6e59649137ed9f669138bb01621c9a919ea4a9861fb8cfff70a5ae816961393429bc6bb9d8194a3d6dad087ffae84272c3e0832ffb89a34b82aca57d43566a02fcaf859fa2721d84be66fc170507d4e0c0fc08d613464c7d6cd9e54bdd03e446f1332fc1e26ac3b9c66383c7125b0b42312e86526f5e394c06705161e2031b4aef21285fc0d6b681d04aa275f8fa9c72e97f20e1c5058b2e329c6119f25a5e69ad74ab1a8aca5ed1b85ad33c4b2d6c814dff9a181d2c80e72fcdc1c082227612cf9394a876630578fa7ca2836e717fb1e683a5dd1cec5d4bc6d0ae8f820a523b019d979815b7d79760c46215d1fc8cc1a27f71224ac95d14b8d3b0836f0a325204e1ed4d08bcf6249cad5c052583ce51ffbd199ab378be6071d111a21cc0b5e9387abdd489d3c9af9f5a8f642736a5e0bc3187be66f61d8c46e9ede9d4688a94194e71d60f047ec552b0c49efabb783224fd620ad57e649cdc79963e3e5f95e78afedf63ae5cf550a4b1852f1882f0c15ab44938a5827071cdc220c0ecf05852c61cf986864f525064932d14c4599c21f058a9b9ed184fd5bc170b893b048540b0f1d8e7a5bc955e007163076ad770c217fde801c4256b6003833419fe6f230d10e418c7b8c20de0ea1210f4b9d1b4328d5657440b8772abc44acbf334122423df67801a6681ac844a472d7f49a6be90598ef8b150424e61386792a4fd90596f6eedb44b7e3e9cef64d5fb4891a845c07a7dbb7d944e04f9fa6bbe70ac669bd08f0aa30ac3f644f11f2e136bb2582690073052333c1f1c1d3a6b9bc53a427ea5bbe122b987a8203ee8ba3f63656d4ee03997e0f9d42652a88581ec0607188fbfaf6975e8f169944fe4ec5638e3ee1ce223eb032ee9fe157ba891012839b84f34544412918c330719c9817ad205f3245153a3e6b37716a4e8e3caeb2305541c29cdc868449091b4b139d424accbf2d751cf569678d456b77fa23b3fa3dbc9b7036bb2a37776ef650e515995c9a9bbc73042098340c9328774f7fcc976e3dd1d55666209176df31304a1dd48a41d709552a39d25d0cb35a812baae95f5f9ceb8fb5771be5deb124fe867734d6301cc22b2e3ce161388d5a982500fca1f631610c416f29cbee3d824e6c851b07ef14a8dc2af31262835f1681449d4367986bc5406e1a117cd1a30d084aedacb0a6653649286b4ffbaab679ed36f786ea13b304522fb5687435b296e9a882ac65c724be101000b8fe35bc4017e08b46e804dfe478d096c55d1f84f7100dfddd0ad9d07f071f4bca68ddaf45e619209a678f382047b2ff413b9c8837eb5838c34284391a35265b2f7ad83c42ce1906b0574a49ae9e396be5016eb83532402b20636dec4b280f0824667335853ecdbc84a67d3d64a12d0f3a9ca72b7e015e5052cde951ab002fc63d1733ea30733219ef0b633a11caaa2e7fbdbd7885d4d9f4e44f5b7b3c02170f56938f9f4bed7b85c14cbfdf7b9ee63861b6a93f2ae066b32f01d6b60bde233da89caff8ae7d6f6a5808bb15b1a1ec14b5ddabed44fe8d88de1583740a2d1e92bf61c1c26e831ee7dfc9452dbf04beaf11157e7648b9e20b069333dd467b2e7fc08677ac62854a178371c1da3511d56a04295785e662417c6208c5e94300179975a2a0bec7ede06e52e6039cadc2c4aeaf609cd29d371da86b0b47e87cb10541385bd39871673a6c0be19f2971ebb6b487f65ebd84b1bc056bea6918c13d26c21fb176948ddf5f4d0a4d94495845aaef2aa0e672faa382c4f82719a76a351ffdfe90c71f8d4a487cfb5c258c1290e75829c6e2eba274d4344458e9d5cfb529763ef306f35c0cf1741cc732389fc8954dae9dfd192ad1e05bec214361ceeb11b788bdca7d45136ca62684e83893e859dddbb5782b0c0ab7e710f8c2f5f86e1d40ac66828c155000bbff8e369ee79364ac44ee581f774014f92554257461ac0377643004d101f7e77ed031ee46b031fa4d19a0165e41e28b2dd2ec361d98281efd5f7d679cdd390fee8b568f95820ad14760a5f62fa48132cc8f38558623571611896a32a3b3e231380231db00f394859811e84442811a5b7eb92616bc489e0240a8ac1adc835af2aef3fd441fa9404247a4afc4d4f5284284d7e7d48f812624cb1fb5bc99200b7341d8145ac5e2129915be93e5967456d87d3203c17d061728f3a8853f2f9c7eecee5766aec2125b6a44843d0d9c357bd68531bd834d24f82bea8833798cb8130eed9c0947626af291178cd14863812068246104af4dcb9222e8b05d12ebd61606499b068c4f4cd0742f0a91317f3df4accc6d3295e23e121b6b5d41c6952143c6cddaf156b98b019b53233de22fd0a15727f7a11a3afab302c2bae92da43943a2c9b2cff2aa07669f712c2b1758d16a1d3d072cfe2f823f256c6c9634222805f7f30bd1cbee3a98de7543c1a114145a9ec00b9be080b51b2aea156d1f55689187938792417bc21951f0fe2c15c886061f3fd90a6d521ab411e81fcce2af9fdcf0811b58620ba8e771c337043c2090190a784ee45ef770d7185e336b75fdcccbfcc2dadea1032b1b10b4fe6f7c085cdabff64d527d8194e307ba6df4b294cd193e7dd95a39014033b2c85eb4649de145d3da90796ee9f8662b097aaa10c2cc1b883656d4a0b1ef75e1d1abbaf17669cee1b5be776a32ac502036994cb045fcc87bfdddc9b84318400db8fdbda2f8ccc7ed49d367245130121b5225652a462c23b7fa2d80c14a5406270be2744cf987fb6abb990a1fe618440c2d8803f5c79d0763acfad0f7faaa96ee39668639421f3ef198a347df971ff527ff9242073ff2b6fd3b2dd63ab2c822ced101daf6e67f574719dd35088a51ef0d1cbb6b71e7d6184a738a0960ccc13ec03b879240f54d065b20870b857c446621a188f492fdd9f88b2f18b50c7bef2f559204ecafc18e6aa07c216a40d7858d254e338eaa6f42ac4dfd832b3acd1d9b49fddd127c500bcebcb14b37000a489f1cd98af21a8c9e7dd3e86134eca580da2658b16a310d9999fab24b80ae22c86a2f991a8dcd83f891eadff93f1bacf154ba26f6e3f9d446cb55691790c07d6f5725860d2c07924f30d4a704f212eff686e3eea2ef73dafc7edfd08ec5c38ad75029e655494a5b15e87bba0f88f88236464239b99c4b532b044d5b7a2454d951231ea5e055bd6220b7e91938be44a52164deb320fc22b185a770cb1b9c36437f131adff2fe0a1871144f6bcd07b5464919fe9d6e27554f090f242aac1763d8bdb0023cf9a9f7eb5768d38e688512ec5a0de32d3374e02762f7ee64a3d8d8a0e3f4249bea704e6552a858324f111d27f678ea2557760429d97e81c88058991361ef1b98837ac5fafbebdf084cca6b7d57aa487dd95a5ef69b806424032fb3beeeba1bf6495129895a88f4d27c24d23a82b9106c430d67dbcb4caf3ff108123a9c05217d61abb325e4dabaa1974a4723e0b847160eeeb9dcb0965f22ad1660e6d1ac1ed371441e72a291547b50a0092841f3103c8b3166957d2e96102b5b0925e86a0728c1851cc3d1cbbb2cc156742de1c86408f535d0bf6ac9c9cb2bfe7dd47a373002bc41bcd24614871f0c91d831a3612d08e94938ef1d4cf2af641bb6c951330388df3cc82840a1204ebe85f8ab72b2b4d05323416b8aeef1188ef45d6b04cb0f78f9f3683bd6a62e9967c0b2fc2cbb605ef5c18f7ae73be40cb9b9706d594101f93e5e7c2e5215b37b0ba42f1e96a374bd7aa6a69fd4996183179e043306d40d8e5c1c199a64594ba7db087c821945b8f4b5e76c3e6542a4afb1c3bd468501302772bdd9fbacf097d04eb872c41c8e3d19852782ed61f99d8e1e3718d03ca1007b02dfc7b40ec5abee2d60a1a34df3fefc60cee3529de29100f1d35119c12102cb61778610c7bc4ead83feffca33b85166c5adf9a0e1d5159d80548d6d4e74175820b08048635ea504105294c37de9c696550357433eebbf05a78fc6ad71f72fae33bc94a6c2c725a28080985994cc4e28d52a97f45629f60ccc140d985747000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002f85596d7f718cefe6cacd31548f368f88dd45add6fb5cfc9c9e2b9d193fae832d7a07360bc578593f0dee7a438e8e76d7eec8bf3562733772a034c41e6c27e021944d0f20f745712eabe3fb706c4c2f251869ca1903d39d0888f577c9b6e08a2f4ebb9cda1c37aacb097c3e00d40f8770e18d5b93063170b5ad4e0ed620708d10b478e22654713d4e30de1d89f92ec28cbe029d23a9dc9712022d27f54ebfdd2aab56bf2f3596df79af4119e7850a133b1a3f548cb2255360fe28c9768aaf6412366047a9053a720ebe77ca384fda5ddb11bacae5184e990609ec7e39a1382d049d9479d3b67bc172a6b06f2d02ad2239f1c4d890e81f216f3b29757d6706b81163cafd91f6d05f46dea2d3682666a36d4a35bdad07f78c8a0a329fe540fbf115c3c0d77f716ab42291f3dad2b30d7d758374ad82b3474d24557a726856dad51f2ae336d34aa643429bf02a37cd24e5a8f74db542f615f15141c6b90ffa63fb018e2853d0c4c4a2079761cd8f247ae8ee5d7e9d908f650e2a1799b1128f5c0802d60d4e65447d756cb5a9050f92880e484871c4d88f1515d8cc43ceefd5a3a6259604ab1184d1aef75b824ed6fff99cc423fb817b0af464ac53f467f555a8272ae06554997805dcd35313ae5a889d8dfe059bda5ce7ba75990f04426a73304704a4bb6cfd815b47ccef6fc4e7d656980bee90fd36d3c6e7b53854c4cc9b0adf1effaccb5a01d4a6ab16cf2d2470484a6465de107cf7aed29b4bcd7eb88180232bb8ffe3eb3dca67ff99e2406cca0fabbde5a683ca1fc73503e2e6721aa1dc8e1d77933e0229b214f2cc231ac647dc2bb6ceaf2fbcaf745c1ca0296e0dfab8be010fa60a7b7eacab40dffee3b2b6d39ed379f7d55298e653c45ef43f74fb66261b9e724f98b14d9663e718a77029bbe650ce8296e1960d4daa3d2b65ba87fcd1237cdb8b0015ec420c60b23c072fdb285195fc251c20c63b11f41ba37c730c02253d53b3253ad779b05e10d658057edbb8b5acf0e70c2a2021c39ca0cd3d0b2e0cfa236069918de85be559edd7076a7bd12bf72b03ca9ab36a49685b53073e4526b8f567222f2ff3a1fee6737173ebaed42c11f3362fb5a763ceb122b492c6a321082a7e11bbf5dc0520d0a1cb8af54e32c2784d7db907c9106cff0959c823141da75ea799a5ad0d1ca011631a8387652da439d9f9e08503bfd8e0ca6e953fc31942581a30fd073e7b43220275247fe27759d88da2d8defc294f89560313b25f0ca8f2af724919662419a6d9177e308d706ee7ab8900b361f739a9afb7061f1602db36eefa6e47a074f0cc1a5c31703bde6504b83c394474a0d4a7ca5018e66708dc26af56dc03152cb45f203b1c19cb1f935aaf3068d5cfcd0761700ee1ff042239e5d2f419236d67c766bc273b296e1f12736186206462ccd40c47d7a6e6660d8bb994a2c27c197bb94deab68231b13a221e9a6b2329e585708bec94ad07be28606b2acf5457308e9fbc4595de726c3b05d93f5c2cc8caf693fdf981a2170428606b2acf5457308e9fbc4595de726c3b05d93f5c2cc8caf693fdf981a217040d7037ffa5d55ee27513002463fc6a52844ca4380169b3d453c07b09792e5a83054c1457d3f1575ba968f17afae946b818820244d751c78298d0ff6454e2bf0225b06b88ed61b047e7e23590c35dad12360de7892376ce42eb4b9751812896801ab5930ba8f90173f920dbe06918bcd65b1a8f1a3726bfce98f7654c68555c191baef0a3d61a1bde53b3b6f7724abcccf379aef4289118521b676ef7e8292671000000000000000000000000000000cfd0edc872233af82676f21cd69eb7c2f1000000000000000000000000000000000010a8ec7f40f8f98c45f0cdefb9a8e60000000000000000000000000000004e7cee8c8f246b87b570ec2e05cf81eb1400000000000000000000000000000000002584d3b907881e5d835e43fc637911000000000000000000000000000000531ed7196d2c538ad1a500ba0e31b38d5500000000000000000000000000000000002e4d85e5032a58bd2d9cb219dd5a64000000000000000000000000000000e9c5ccd897feee87fad852d66bf270141e000000000000000000000000000000000000ee4cdf71912d8188f97529c5c76a000000000000000000000000000000b74bfbaa056e7cc1b1d1feeab39a53198000000000000000000000000000000000000de213dc889022490db2899df73a21000000000000000000000000000000db93f6ff7c2d569ee600d2ff2b108c3a3a0000000000000000000000000000000000163e3cef2514c7a7702a0654ec34380000000000000000000000000000009e448c4e263dc126d944f6f771998cfe9200000000000000000000000000000000001c204462dd8fd7da4df4bca8c28191000000000000000000000000000000074649790397a29d3b1feb22b274f3645b00000000000000000000000000000000000188d9228a721bf684f356ab05bf81000000000000000000000000000000536e8468f3c5b56a86acde4c9918e9547000000000000000000000000000000000001aa8d4cbfc0dae197e08b6a6f90c0c00000000000000000000000000000030c08280978ecca708c73a0d38324eeddf00000000000000000000000000000000000017a4eb3450eae0c72f52e5d698ea000000000000000000000000000000b2ac2dd67c0d63a3fdcb75331a158788eb00000000000000000000000000000000000174ba34701bb806b3eeba82a66fc30000000000000000000000000000004ab1a1558863129fdacc9c9a96fd2b58c0000000000000000000000000000000000005d171f67df92cb0985dc3f6bf7ffd00000000000000000000000000000034ddeaaa3ad0b05c771335925d8f3a4d5100000000000000000000000000000000000da020cf53b181584c992bd51d6820000000000000000000000000000000af5f771d99c9d7b02b8c0017c1d6e1d83900000000000000000000000000000000001d337d4d6e102641dc2abc59608268000000000000000000000000000000659cfb52045e3cb7c3b2619ebddbbe41b000000000000000000000000000000000002f854d2fffbd0f73624c9cac29311a000000000000000000000000000000caa20ecf36a67fdbb0e459e61d1a4c60d20000000000000000000000000000000000124806d62afc139bd933ee909804df0000000000000000000000000000006c6089728ea64ccd21ba392e6b12b2916d00000000000000000000000000000000001ab7f214051d91785d81bbcd48e894000000000000000000000000000000bbe18cf94fa28d8fe566a5d9ceffa1eca800000000000000000000000000000000002ee9735a3d42bf8dc46261cb309dfc000000000000000000000000000000f3389ed37859de87f88695a0e194e6eec700000000000000000000000000000000001c4a34d394e6bb331f7582ba8c85bd00000000000000000000000000000043ba92ae90a5d6098b1313d406d0959c7200000000000000000000000000000000001abb146f6c1bb2d1fdf64fd123a38d000000000000000000000000000000ff6dcceb8d3c4304134bda6b3ea7c69c2900000000000000000000000000000000001adfffbcbaf3a73df3b9453f4a90820000000000000000000000000000000705fec53534372a927688b7128cdbaad3000000000000000000000000000000000012ae97292f1ae819ebdc30cbf2df6c000000000000000000000000000000020d027ea6aa85de6aaef21ec74e67e6e4000000000000000000000000000000000019540269632c517d600210cab7f57f000000000000000000000000000000c3d9a67c1a2b1d7419432b289324d1e97b00000000000000000000000000000000000c2ede208bc80f8baed26f7b18a25800000000000000000000000000000078d18f3a3d37df84890a7e829dee5b133200000000000000000000000000000000000d62fd15910bb79575b52db7620628000000000000000000000000000000adfd9dc0b830a00ba6bdb0cc3667123c9b00000000000000000000000000000000001bed0ffa64fca87e1e5501ac74cf7e000000000000000000000000000000afe5cc4df1a478bf9a60862e928f218215000000000000000000000000000000000016a96aed40177a678f04477a529656000000000000000000000000000000df2ea347b4317d52b37a16e2590d92325a000000000000000000000000000000000005ff46d622881f2d92164f10008dd4000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000d7477dd26ac4e67adfdf0c9d153962cf84b8662ff6bb3836b91861c588f5e510f0b51c369ff41c8cc7866877d2086cb3c2b1fb4237ce302da1ff046e7805b32044e08910ec8341490744e3f1c9fc16fee4e5b4e95d5dcca0f03f353082eac425120f00fdf942b8a5942a57ece0f692671b638863d05a8291595f79ed17e5d404c365fb978689c34fdd0488cdc2785ef0afe8ba0d919b63ab6ff2bee7f2fb06002c2c4b6bfc25120f73001a41d98fd3582db214e2c724b929f2961866e82bc125ed0172f829f95d99684573c4bbc7ad48f7a57549db4ec35dd8057e6fcebce512f5274497c7f4a38bef8a4857853d913f7976c55002b221981153a95839412b2f3c161e9aee1fae33c9e3cda63eaca607c779057205025860a2d3a9b8568f6a2b37a74f790c6e2da5e3b50715ef8edd8f9e56547c5fa1f096e08cfe6358e23b029091cd30fb04ff6db2b7e30e88d2f9862372812346bd20d0c71dade5daa54a0db62f7f25cd13efad195455eedf8b93071c0a885f78344c80ff128181b18edb12b5652834f0a07a035a0fa5eb86e5d9233dc652f7c811f7c3122b2a50cfce0812bfc46bc2810e11c2cf7ae2dd18f978c25c031cc8ba2aaeb74fbc1c20aeee23118deb2e3b55e64f8bc575ee0e6cdbf39e3f161db11c3183bd447db30e2e08410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ee6a76ef544cfcb018d53c33757b25d4f80000000000000000000000000000000000006dc1673e46a68792405d77712382000000000000000000000000000000f41cf1ca58a28b6c51e2fe28a4db3b1e1a0000000000000000000000000000000000132ecd03b38c19e33404687eb8ca85000000000000000000000000000000bc5679343f076d02fb512c79675030cae900000000000000000000000000000000001fa01ca322e502386a0b7c247f173d0000000000000000000000000000006a49e64c42db2bd328de382e893e1f3ada00000000000000000000000000000000002d6df58711c4457eb9d2c7efee2826";

    function test_mixer_single_deposit() public {
        mETH.approve(address(zk_lend_mixer), 1300000);
        vm.warp(1746826656 + 1 minutes);
        zk_lend_mixer.deposit(
            0x1296784b1c2414377826486fed0409eeee5850e3a46e73fd18ac4ce0b3d12253,
            0x0000000000000000000000000000000000000000000000000000000000c65d40,
            1746826656,
            0x045132221d1fa0a7f4aed8acd2cbec1e2189b7732ccb2ec272b9c60f0d5afc5b,
            0x0000000000000000000000000000000000000000000000000000000000000000,
            proof,
            1300000,
            mETH
        );
        // // 1. Generate commitment and deposit
        // uint256 lend_amt = 10;
        // uint256 borrow_amt = 0;
        // uint256 will_liq_price = 0;
        // uint256 timestamp = block.timestamp;
        // (
        //     bytes32 commitment,
        //     bytes32 nullifier,
        //     bytes32 secret
        // ) = _getCommitment(lend_amt, borrow_amt, will_liq_price, timestamp);
        // mETH.approve(address(zk_lend_mixer), lend_amt);
        // zk_lend_mixer.deposit(commitment, lend_amt, timestamp);
        // // 2. Generate witness and proof to prove ownership of prev_note for borrow more
        // MyNote memory prev_note = MyNote({
        //     lend_amt: lend_amt,
        //     borrow_amt: borrow_amt,
        //     will_liq_price: will_liq_price,
        //     timestamp: timestamp,
        //     nullifier: nullifier,
        //     secret: secret
        // });
        // // TODO: These functions should be precomputed from frontend
        // uint256 lend_interest_update = 1;
        // uint256 additional_borrow_amt = 3;
        // uint256 new_lend_amt = prev_note.lend_amt + lend_interest_update;
        // uint256 new_borrow_amt = prev_note.borrow_amt + additional_borrow_amt;
        // // TODO: Also come from frontend
        // uint256 new_will_liq_price = 21;
        // uint256 new_timestamp = block.timestamp;
        // (
        //     bytes32 new_commitment,
        //     bytes32 new_nullifier,
        //     bytes32 new_secret
        // ) = _getCommitment(
        //         new_lend_amt,
        //         new_borrow_amt,
        //         new_will_liq_price,
        //         new_timestamp
        //     );
        // MyNote memory new_note = MyNote({
        //     lend_amt: new_lend_amt,
        //     borrow_amt: new_borrow_amt,
        //     will_liq_price: new_will_liq_price,
        //     timestamp: new_timestamp,
        //     nullifier: new_nullifier,
        //     secret: new_secret
        // });
        // bytes32[] memory leaves = new bytes32[](1);
        // leaves[0] = commitment;
        // // TODO: Fix priWitness
        // (
        //     uint256 priWitness,
        //     bytes32 root,
        //     bytes32 nullifierHash
        // ) = _getWitnessAndProof(
        //         prev_note,
        //         new_note,
        //         additional_borrow_amt,
        //         zk_lend_mixer.flatten_liquidated_array(),
        //         leaves
        //     );
        // // 3. Borrow funds from the contract. (verifying logic is in borrow function)
        // // assertEq(recipient.balance, 0);
        // // assertEq(address(mixer).balance, 1 ether);
        // zk_lend_mixer.borrow(
        //     priWitness,
        //     root,
        //     nullifierHash,
        //     new_commitment,
        //     recipient,
        //     new_will_liq_price,
        //     additional_borrow_amt
        // );
        // // assertEq(recipient.balance, 1 ether);
        // // assertEq(address(mixer).balance, 0);
    }
}
